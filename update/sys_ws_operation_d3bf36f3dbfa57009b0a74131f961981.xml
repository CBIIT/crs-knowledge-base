<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sys_ws_operation">
    <sys_ws_operation action="INSERT_OR_UPDATE">
        <active>true</active>
        <consumes>application/json,application/xml,text/xml</consumes>
        <consumes_customized>false</consumes_customized>
        <default_operation_uri/>
        <enforce_acl>cf9d01d3e73003009d6247e603f6a990</enforce_acl>
        <http_method>GET</http_method>
        <name>getDocumentById</name>
        <operation_script><![CDATA[(function process(/*RESTAPIRequest*/ request, /*RESTAPIResponse*/ response) {
	var template = {"u_kb_template_top_accomplishment":['Title','Cancer Site/Type','Research Type','Special Topic','Description','References','Involved organization', 'DOC', 'Fiscal Year'],
					 "u_kb_template_literature_summary": ['Title','Cancer Site/Type', 'Research Type','Description','References','Funding','Journal','Special Topic','Fiscal Year'],
					 "u_kb_template_gpra": ['Title','Measure ID','Research Type','Special Topic','DOC','Contacts','Description',
											'Summary','Background','Target Context and Conditions', 'Fiscal Year'],
					"u_kb_template_miscellaneous": ['Title','Cancer Site/Type', 'Research Type','Description','Special Topic','Fiscal Year'],
					"u_kb_template_final_reports": ['Title','Cancer Site/Type', 'Research Type','Description','Special Topic','Fiscal Year'],
					"u_kb_template_significant_items": ['Title','Cancer Site/Type', 'Research Type','Special Topic','Congressional Language','Action taken or to be taken','References','CRS Author','Fiscal Year'],
					"u_kb_template_miscellaneous_me": ['Title','Moonshot Recommendation',
									 'Cross-cutting themes and goals',
									 'CMIT',
									 'Description',
									 'Point of contact and contact information',
									 'Fiscal Year'],
					"u_kb_template_presentations": ['Title',
													'CRS POC(s)',
													'Project',
									 'Originated outside of CRS',
									 'Obtained permission to share within CRS',
									 'Originator/Owner',
									 'Date Presented or Shared',
									 'Presented to',
									 'Presented to leadership level',
									 'Presented to public',
													'Brief Description',
													'Placeholder: Suggested tags/keywords',
													'Where related information can be found',
													'Comments',
													'Includes analysis',
													'Are the data in draft form',
													'Is the underlying data covered under a DUDA',
													'Analysis Notes']
				   };

	var data_columns = {
                "u_kb_template_top_accomplishment":{
                                "Title":"x_26385_crs_kd_u_kb_title",
                                "Cancer Site/Type":"x_26385_crs_kd_u_kb_cancer_site_type", 
                                "Description":"x_26385_crs_kd_u_kb_description",
                                "DOC":"x_26385_crs_kd_u_kb_doc",
								"Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year",
                                "Involved organization":"x_26385_crs_kd_u_kb_involved_organization",
                                "References":"x_26385_crs_kd_u_kb_references",
                                "Research Type":"x_26385_crs_kd_u_kb_research_type",
					            "Special Topic":"x_26385_crs_kd_u_kb_special_topic"
                },
                "u_kb_template_literature_summary":{
                                "Title":"x_26385_crs_kd_u_kb_title",
								"Cancer Site/Type":"x_26385_crs_kd_u_kb_cancer_site_type", 
								"Research Type":"x_26385_crs_kd_u_kb_research_type",
					            "Special Topic":"x_26385_crs_kd_u_kb_special_topic",            
								"Description":"x_26385_crs_kd_u_kb_description",
								"Funding":"x_26385_crs_kd_u_kb_funding",
								"Journal":"x_26385_crs_kd_u_kb_journal",
                                "References":"x_26385_crs_kd_u_kb_references",
                                "Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year"
                },
		        "u_kb_template_gpra":{
                                "Title":"x_26385_crs_kd_u_kb_title",
					            "Measure ID":"x_26385_crs_kd_u_kb_measure_id",
					            "Research Type":"x_26385_crs_kd_u_kb_research_type",
					            "Special Topic":"x_26385_crs_kd_u_kb_special_topic",
								"DOC":"x_26385_crs_kd_u_kb_doc",
								"Contacts":"x_26385_crs_kd_u_kb_contacts",
                                "Description":"x_26385_crs_kd_u_kb_description",
                                "Summary":"x_26385_crs_kd_u_kb_summary",
								"Background":"x_26385_crs_kd_u_kb_background",
                                "Target Context and Conditions":"x_26385_crs_kd_u_kb_target_context_and_conditions",
                                "Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year"
                },
                "u_kb_template_miscellaneous":{
                                "Title":"x_26385_crs_kd_u_kb_title",
								"Cancer Site/Type":"x_26385_crs_kd_u_kb_cancer_site_type", 
								"Research Type":"x_26385_crs_kd_u_kb_research_type",
					            "Special Topic":"x_26385_crs_kd_u_kb_special_topic",            
								"Description":"x_26385_crs_kd_u_kb_description",
                                "Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year"
                },
                "u_kb_template_final_reports":{
                                "Title":"x_26385_crs_kd_u_kb_title",
								"Cancer Site/Type":"x_26385_crs_kd_u_kb_cancer_site_type", 
								"Research Type":"x_26385_crs_kd_u_kb_research_type",
					            "Special Topic":"x_26385_crs_kd_u_kb_special_topic",            
								"Description":"x_26385_crs_kd_u_kb_description",
                                "Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year"
                },
                "u_kb_template_significant_items":{
                                "Title":"x_26385_crs_kd_u_kb_title",
								"Cancer Site/Type":"x_26385_crs_kd_u_kb_cancer_site_type", 
								"Research Type":"x_26385_crs_kd_u_kb_research_type",
					            "Special Topic":"x_26385_crs_kd_u_kb_special_topic",
					            "Congressional Language":"x_26385_crs_kd_u_kb_congressional_language",
					            "Action taken or to be taken":"x_26385_crs_kd_u_kb_action_taken_or_to_be_taken",
								"References":"x_26385_crs_kd_u_kb_references",
					            "CRS Author":"x_26385_crs_kd_u_kb_crs_author",
                                "Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year"
                },
                "u_kb_template_miscellaneous_me":{
                                "Title":"x_26385_crs_kd_u_kb_title",
								'Moonshot Recommendation': "x_26385_crs_kd_u_kb_moonshot_recommendation",
								'Cross-cutting themes and goals':"x_26385_crs_kd_u_kb_cross_cutting_themes_and_goals",
								'CMIT':"x_26385_crs_kd_u_kb_cmit",
								'Description':"x_26385_crs_kd_u_kb_description",
								'Point of contact and contact information':"x_26385_crs_kd_u_kb_point_of_contact_and_contact_information",
                                "Fiscal Year":"x_26385_crs_kd_u_kb_fiscal_year"
                },
		        "u_kb_template_presentations":{
									'Title':"x_26385_crs_kd_u_kb_title",
									'CRS POC(s)':"x_26385_crs_kd_u_kb_crs_poc_s",
									'Project':"x_26385_crs_kd_u_kb_project",
									 'Originated outside of CRS':"x_26385_crs_kd_u_kb_originated_outside_of_crs",
									 'Obtained permission to share within CRS':"x_26385_crs_kd_u_kb_obtained_permission_to_share",
									 'Originator/Owner':"x_26385_crs_kd_u_kb_originator_owner",
									 'Date Presented or Shared':"x_26385_crs_kd_u_kb_date_presented_or_shared",
									 'Presented to':"x_26385_crs_kd_u_kb_presented_to",
									 'Presented to leadership level':"x_26385_crs_kd_u_kb_presented_to_leadership_level",
									 'Presented to public':"x_26385_crs_kd_u_kb_presented_to_public",
													'Brief Description':"x_26385_crs_kd_u_kb_brief_description",
													'Placeholder: Suggested tags/keywords':"x_26385_crs_kd_u_kb_suggested_tags_keywords",
													'Where related information can be found':"x_26385_crs_kd_u_kb_related_information",
													'Comments':"x_26385_crs_kd_u_kb_comments",
													'Includes analysis':"x_26385_crs_kd_u_kb_includes_analysis",
													'Are the data in draft form':"x_26385_crs_kd_u_kb_data_in_draft_form",
													'Is the underlying data covered under a DUDA':"x_26385_crs_kd_u_kb_data_covered",
													'Analysis Notes':"x_26385_crs_kd_u_kb_analysis_notes"}
};
 
    var document_id = request.queryParams.id;
	var table_name = request.queryParams.name;
	var version = request.queryParams.version.toString();
	
	var column_label = template[table_name];
    var temp = data_columns[table_name];

    var column_name = [];
    for(var i = 0; i < column_label.length; i++){
        column_name[i] = temp[column_label[i]];
    }
	
	var item = new GlideRecord(table_name);
		item.addQuery('sys_id', document_id);
	item.query();
	item.next();
	
	var result = {};
	result.number = item.number.toString();
	result.kb = item.kb_knowledge_base.toString();
	result.cat = item.getDisplayValue("kb_category");
	result.author = item.getDisplayValue('author');
	result.author_id = item.author.toString();
	result.version = item.x_26385_crs_kd_u_kb_article_version.toString();
	result.warning = item.x_26385_crs_kd_u_kb_caution_warning.toString();
	if(version == "" || parseFloat(version) == parseFloat(result.version)){
		result.latest = true;
	}
	else{
		result.latest = false;
	}
	
	if(result.latest){
		for(var j = 0; j < column_name.length; j++){
			if(item.getDisplayValue(column_name[j]) == null || item.getDisplayValue(column_name[j]).trim().length == 0){
				result[column_label[j]] = "N/A";					
			}else{
				result[column_label[j]] = item.getDisplayValue(column_name[j]);
				if(result[column_label[j]].charAt(0) == '{'){
					result[column_label[j]] = result[column_label[j]].replace(/{/g, '').replace(/}/g, '');
				}
			 }
		}
	}
	else{
		result.version = version;
		//get data from versions table
		var v = new GlideRecord('x_26385_crs_kd_versions');
		v.addQuery('article_number', result.number);
		v.addQuery('article_version', version);
		v.query();
		if(v.getRowCount() > 0){
			var cache = {};
			while(v.next()){
				cache[v.article_field.toString()] = v.article_field_value.toString();
			}
		
			for(var k = 0; k < column_name.length; k++){
				if(cache[column_name[k]].trim().length == 0){
					result[column_label[k]] = "N/A";					
				}else{
					result[column_label[k]] = cache[column_name[k]];
					if(result[column_label[k]].charAt(0) == '{'){
						result[column_label[k]] = result[column_label[k]].replace(/{/g, '').replace(/}/g, '');
					}
				 }
			}
		}
		
	}
	
	
	var cm = new GlideRecord('x_26385_crs_kd_comments');
	cm.addQuery('status','1'); //1 - new, 0 - archived
	cm.addQuery('article_number',document_id);
	cm.query();
	var comments = [];
	while(cm.next()){
		comments.push({sys_id: cm.sys_id.toString(),	
					  userID:cm.userid.toString(),
					  userName:cm.username.toString(),
					  comment:cm.comment.toString(),
					  time: cm.sys_created_on.toString()});
	}
	result.comments = comments;
	result.tags = item.x_26385_crs_kd_u_kb_tags.toString();
	
	//get personal tags
	var userid = gs.getUserID();
	
	var t = new GlideRecord('x_26385_crs_kd_tags');
	t.addQuery('article_number', result.number);
	t.addQuery('knowledge_base', result.kb);
	t.addQuery('userid', userid);
	t.query();
	if(t.getRowCount() > 0){
		t.next();
		var tmp = t.tags.toString();
		result.your_tags = tmp == "" ? [] : tmp.split("#");
	}
	else{
		result.your_tags = [];
	}
	
	
	//check if this version is editable
	if(result.latest){
		result.editable = true;
	}
	else{
		result.editable = true;
		var ceiling_version = Math.floor(parseFloat(result.version)) + 1;
		var ed = new GlideRecord('x_26385_crs_kd_versions');
			ed.addQuery('article_number', result.number);
			ed.addQuery('article_version', '<', ceiling_version);
			ed.addQuery('article_version', '>', result.version);
			ed.addQuery('article_field', 'annotation');
			ed.query();
		if(ed.getRowCount() > 0){
			result.editable = false;
		}
	}
	
	//get attachments and annotation
	result.attachments = [];
	result.annotation = "";
	var attach = "";
	var att = new GlideRecord('x_26385_crs_kd_versions');
		att.addQuery('article_number', result.number);
		att.addQuery('article_version', result.version);
	//	att.addQuery('article_field', 'attachments');
		att.query();
	while(att.next()){
		if(att.article_field == 'attachments'){
			attach = att.article_field_value.toString();
			var gr = new GlideRecord('sys_attachment');
			gr.addQuery("table_sys_id", document_id);
			gr.addQuery('content_type','STARTSWITH','application/');
			gr.addQuery('sys_id','IN',attach);
			gr.query();
			while (gr.next()){
				var tmp = {};
				tmp.attach_sys_id = gr.sys_id.toString();
				tmp.file_name = gr.file_name.toString();
				tmp.file_type = gr.content_type.toString();
				tmp.created_by = gr.sys_created_by.toString();
				result.attachments.push(tmp);
			}
		}
		else if(att.article_field == 'annotation'){
			result.annotation = att.article_field_value.toString();
		}
	}
  
	return result;
})(request, response);]]></operation_script>
        <operation_uri>/api/x_26385_crs_kd/export/getDocumentById</operation_uri>
        <produces>application/json,application/xml,text/xml</produces>
        <produces_customized>false</produces_customized>
        <relative_path>/getDocumentById</relative_path>
        <request_example/>
        <requires_acl_authorization>false</requires_acl_authorization>
        <requires_authentication>true</requires_authentication>
        <short_description/>
        <sys_class_name>sys_ws_operation</sys_class_name>
        <sys_created_by>zhoujim@nih.gov</sys_created_by>
        <sys_created_on>2018-06-26 20:52:59</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>d3bf36f3dbfa57009b0a74131f961981</sys_id>
        <sys_mod_count>64</sys_mod_count>
        <sys_name>getDocumentById</sys_name>
        <sys_package display_value="CRS Knowledge Database" source="x_26385_crs_kd">404e613b4f9213007221e321a310c738</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="CRS Knowledge Database">404e613b4f9213007221e321a310c738</sys_scope>
        <sys_update_name>sys_ws_operation_d3bf36f3dbfa57009b0a74131f961981</sys_update_name>
        <sys_updated_by>yuw5@nih.gov</sys_updated_by>
        <sys_updated_on>2019-05-30 21:23:24</sys_updated_on>
        <web_service_definition display_value="export">01e1bbe7db6a53005358dc50cf961994</web_service_definition>
        <web_service_version/>
    </sys_ws_operation>
</record_update>
